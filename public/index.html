<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Negociações</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
</head>
<body class="container teal">
  <h1 class="center-align white-text">Negociações</h1>

	<div id="mensagem_view"></div>

	<div class="card-panel">
	  <form class="form row" onsubmit="ctrl.adiciona(event)">
	    <div class="input-field col s12 m6 l5">
	    	<i class="material-icons prefix">date_range</i>
	      <label for="data">Data</label>
	      <input type="text" id="data" class="validate" required autofocus>
	    </div>

	    <div class="input-field col s12 m3 l2">
	    	<i class="material-icons prefix">add</i>
	      <label for="quantidade">Quantidade</label>
	      <input type="number" min="1" step="1" id="quantidade" value="1" class="validate" required>
	    </div>

	    <div class="input-field col s12 m3 l2">
	    	<i class="material-icons prefix">attach_money</i>
	      <label for="valor">Valor</label>
	      <input id="valor" type="number" min="0.01" step="0.01" value="0.0" class="validate" required>
	    </div>

	    <div class="col s12 l3 center-align">
			  <button class="btn-large waves-effect green" type="submit">
			  	<i class="material-icons left">add</i>
			  	Incluir
			  </button>
	    </div>
	  </form>

		<div class="row">
		  <div class="col s12 center-align">
		    <button class="btn waves-effect blue" onclick="ctrl.importaNegociacoes()">
		    	<i class="material-icons left">cloud_download</i>
		      Importar
		    </button>

		    <button class="btn waves-effect blue" onclick="ctrl.apagaTudo()">
		    	<i class="material-icons left">refresh</i>
		      Apagar
		    </button>
		  </div>
		</div>
	</div>

  <div class="card-panel">
	  <div id="negociacoes_view"></div>
	</div>

	<!-- custom files, app files -->
	<script src="js/services/ProxyFactory.js"></script>
	<script src="js/services/HttpService.js"></script>
	<script src="js/services/NegociacaoService.js"></script>

	<script src="js/helpers/Bind.js"></script>
	<script src="js/helpers/DateHelper.js"></script>

	<script src="js/models/Mensagem.js"></script>
	<script src="js/models/Negociacao.js"></script>
	<script src="js/models/ListaNegociacoes.js"></script>

	<script src="js/views/View.js"></script>
	<script src="js/views/MensagemView.js"></script>
	<script src="js/views/NegociacoesView.js"></script>

	<script src="js/controllers/NegociacaoController.js"></script>

	<script>
		let ctrl = new NegociacaoController()

		/* how to use indexedDB simplified example */
		let connection;
		let openRequest = window.indexedDB.open('exemplo', 3);

		openRequest.onupgradeneeded = e => {
			console.log('Updating "exemplo" indexedDB')

			let db = e.target.result

			if(db.objectStoreNames.contains('negociacoes'))
				db.deleteObjectStore('negociacoes')

			db.createObjectStore('negociacoes', {autoIncrement: true})
		}

		openRequest.onsuccess = e => {
			connection = e.target.result
			console.log('Connected "exemplo" indexedDB')
		}

		openRequest.onerror = e => {
			console.log(e.target.error)
		}

		function adiciona() {
			let transaction = connection.transaction(['negociacoes'], 'readwrite')
			let store = transaction.objectStore('negociacoes')
			let negociacao = new Negociacao(new Date(), 1, 1)
			let request = store.add(negociacao)

			request.onsuccess = e => {
				console.log('negociacao added!')
			}

			request.onerror = e => {
				console.log('error when adding negociacao')
			}
		}

		function listaTodos() {
			let transaction = connection.transaction(['negociacoes'], 'readwrite')
			let store = transaction.objectStore('negociacoes')
			let negociacoes = []

			let cursor = store.openCursor()

			cursor.onsuccess = e => {
				let current = e.target.result

				if(current) {
					let dados = current.value
					negociacoes.push(new Negociacao(new Date(dados._data), dados._quantidade, dados._valor))
					current.continue()
				} else console.log(negociacoes)
			}

			cursor.onerror = e => {
				console.log(`indexedDB cursor error: ${e.target.error}`)
			}
		}
	</script>
</body>
</html>
